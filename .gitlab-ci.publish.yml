include:
  - "/.gitlab-ci.config.yml"

check:
  extends: .publish-crate
  script:
    - |
      cargo metadata --format-version 1 |
      jq -r '.workspace_members | .[]' |
      cut -d ' ' -f1 |
      xargs -I {} curl -sSLf https://crates.io/api/v1/crates/{} |
      jq -r ' .crate.name  + " " + .versions[].num '

.publish-crate:
  variables:
    COMPVER: $CI_JOB_NAME
  stage: release
  rules:
    - if: '$COMPVER =~ /-[^\/]+$/ && $CI_COMMIT_REF_NAME != "master"'
      when: always
    - if: '$COMPVER !~ /-[^\/]+$/ && $CI_COMMIT_REF_NAME == "master"'
      when: always
    - when: never
  cache:
    key:
      files:
        - Cargo.lock
    paths:
      - target/
      - $CARGO_HOME
    policy: pull
  before_script:
    - rustc --version --verbose
    - cargo --version --verbose
  script:
    - COMPONENT="$(dirname "$COMPVER")"
    - VERSION="${COMPVER##$COMPONENT/}"
    - echo "Releasing component ${COMPONENT:?cannot be empty} v ${VERSION:?cannot be empty}"
    - cargo test --manifest-path "$COMPONENT/Cargo.toml" --release --color always
    - test "$VERSION" == "$(cargo pkgid --manifest-path "$COMPONENT/Cargo.toml" | cut -d '#' -f2- | tr -d '\n')"
    - cargo publish --manifest-path "$COMPONENT/Cargo.toml" --token "$CRATES_KEY" --color always
