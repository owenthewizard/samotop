include:
  - ".gitlab-ci.builder.yml"

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"

stages:
  - build
  - test
  - release

debug-build:
  stage: build
  only:
    - branches
  cache:
    paths: &cache-paths
      - target/
      - $CARGO_HOME
  artifacts:
    paths:
      - target/debug/samotop-server
      - Cargo.lock
  script:    
    - mkdir -p target
    - du -shx target
    - du -shx "$CARGO_HOME"
    - cargo build --all-features --color always
    # cleanup target folder
    - ./clean.sh

release-build:
  stage: build
  only:
    - /^release\/*/
    - /^hotfix\/*/
    - master
  cache:
    paths: *cache-paths
    policy: pull
  artifacts:
    paths:
      - target/release/samotop-server
      - Cargo.lock
  script:    
    - cargo build --release --color always
    - cargo test --release --color always

stable-test:
  stage: build
  only:
    - branches
  cache:
    paths: *cache-paths
    policy: pull
  script:
    - cargo test --all-features --color always

clippy-test:
  extends: stable-test
  script:
    - cargo clippy --all-features --color always -- -Dclippy::all

check-test:
  extends: stable-test
  script:
    - cargo check --all-features --bins --tests --benches --examples --color always
    - ./fix.sh

audit-test:
  extends: stable-test
  script:
    - cargo audit --deny warnings --color always

nightly-test:
  stage: build
  allow_failure: true
  variables:
    RUST_BACKTRACE: 1
  only:
    - branches
  cache:
    key: nightly
    paths: *cache-paths
  before_script:
    - rustup default nightly
    - rustc --version --verbose
    - cargo --version --verbose
    - rustup component add clippy rustfmt
    - cargo install cargo-readme
    - cargo install cargo-sweep
  script:
    - cargo test --all-features --color always
    - cargo clippy --all-features --color always -- -Dclippy::all
    - cargo check --all-features --bins --tests --benches --examples --color always
    - ./fix.sh
    # cleanup target folder
    - ./clean.sh

.example-template:
  stage: build
  only:
    - branches
  cache:
    paths: *cache-paths
    policy: pull
  script:
    - cargo build --example ${EXAMPLE:?} --color always
    - RUST_LOG=trace cargo run --example ${EXAMPLE:?} &
    - sleep 10
    - |
      sed -e 's/$/\r/' <<EOF | curl -v --url 'smtp://localhost:2525' \
      --mail-from from@spf.org \
      --mail-rcpt to@mikesh.info \
      --upload-file - > client.log 2>&1 \
      || echo "${FAILED:=sending mail failed}"
      From: Moohoo <moo@hoo.com>
      To: Yeeehaw <ye@haw.com>
      Subject: Try me


      .
      ..
      xoxo
      EOF
    - cat client.log | grep -v '* Expire in'
    - find tmp/samotop/spool/new/ -print -exec cat {} \; || true
    - test -z "${FAILED}"

example-lmtp:
  extends: .example-template
  variables:
    EXAMPLE: to-lmtp-tcp
  services:
    - name: dovecot/dovecot:2.3.11
      alias: dovecot

example-default:
  extends: .example-template
  variables:
    EXAMPLE: default

example-dir:
  extends: .example-template
  variables:
    EXAMPLE: to-dirmail

example-cmd:
  extends: .example-template
  variables:
    EXAMPLE: on-cmd
  script:
    - cargo build --example ${EXAMPLE:?}
    - |
      sed -e 's/$/\r/' <<EOF | cargo run --example ${EXAMPLE:?}
      lhlo boogie
      mail from:<from@spf.org>
      rcpt to:<to@mikesh.info>
      data
      From: Moohoo <moo@hoo.com>
      To: Yeeehaw <ye@haw.com>
      Subject: Try me

      xoxo
      .
      quit
      EOF
    - find tmp/samotop/spool/new/ -print -exec cat {} \;

publish-crate:
  variables:
    COMPVER: $CI_COMMIT_TAG
  stage: release
  only:
    - tags
  cache:
    paths: *cache-paths
    policy: pull
  artifacts:
    paths:
      - Cargo.lock
  script:
    - COMPONENT="$(dirname "$COMPVER")"
    - VERSION="${COMPVER##$COMPONENT/}"
    - echo "Releasing component ${COMPONENT:?cannot be empty} v ${VERSION:?cannot be empty}"
    - cargo test --manifest-path "$COMPONENT/Cargo.toml" --release --color always
    - test "$VERSION" == "$(cargo pkgid --manifest-path "$COMPONENT/Cargo.toml" | cut -d '#' -f2- | tr -d '\n')"
    - cargo publish --manifest-path "$COMPONENT/Cargo.toml" --token "$CRATES_KEY" --color always

publish-docker:
  stage: release
  image: "docker:git"
  services:
    - docker:dind
  only:
    changes:
      - samotop-server/**/*
    refs:
      - master
  script:
    - cp -ra samotop-server/docker target/
    # Copy either debug or release binary
    - cp target/release/samotop-server target/docker/samotop
    - cd target/docker/
    - docker build -t samotop .
    - cd ../../
    - docker run -t --rm samotop --help
    # extract version
    - VER="$(docker run -t --rm samotop --version | cut -d ' ' -f2- | tr -d '\r\n')"
    - echo "version=$VER"
    # local tagging
    - TAG_CURRENT="brightopen/samotop:$VER"
    - TAG_MINOR="brightopen/samotop:${VER%.*}"
    - TAG_MAJOR="brightopen/samotop:${VER%%.*}"
    - TAG_LATEST="brightopen/samotop:latest"
    - |
      echo "Tags
        current: $TAG_CURRENT (willbe published only on develop or master)
        minor: $TAG_MINOR (willbe published only on master)
        major: $TAG_MAJOR (willbe published only on master)
        latest: $TAG_LATEST (willbe published only on master)
      "
    - docker tag samotop "$TAG_CURRENT"
    - docker tag samotop "$TAG_MINOR"
    - docker tag samotop "$TAG_MAJOR"
    - docker tag samotop "$TAG_LATEST"
    # remote docker hub push
    - docker login -u "$DOCKER_USR" -p "$DOCKER_PWD"
    # push current version
    - case "$CI_COMMIT_REF_NAME" in master|develop) docker push "$TAG_CURRENT" ;; *) echo Will only push current from master or develop branch, not from \'"$CI_COMMIT_REF_NAME"\' ;; esac
    # push stable version as latest
    - case "$CI_COMMIT_REF_NAME" in master) docker push "$TAG_MINOR" && docker push "$TAG_MAJOR" && docker push "$TAG_LATEST" ;; *) echo Will only push latest from master branch, not from \'"$CI_COMMIT_REF_NAME"\' ;; esac
